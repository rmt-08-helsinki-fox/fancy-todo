<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
  <title>Document</title>
</head>
<body>
  <div id="name">
    <h1>This is your Todo List</h1>
  </div>
  <!--register-->
  <div id="register">
    <button class="btn btn-primary mb-2">Register</button>
  </div>

  <!--log out-->
  <div id="logout">
    <button class="btn btn-danger">LogOut</button>
  </div>

  <!--show todo list-->
  <center>
      <table class="table table-striped" id="todo-table">
        <thead>
          <tr>
            <th scope="col">Id Todo</th>
            <th scope="col">Title</th>
            <th scope="col">Description</th>
            <th scope="col">Status</th>
            <th scope="col">Due Date</th>
            <th scope="col">Actions</th>
          </tr>
        </thead>
        <tbody id="todo-list">
        </tbody>
      </table>
  </center>

  <!--add todo-->
  <div id="form-add-todo">
    <center>
      <h1>Form Add Todo</h1>
      <form >
        <div class="form-group">
          <label for="">Title</label><br>
          <input type="text" id="todo-title-add"><br>
          <label for="">Description</label><br>
          <input type="text" id="todo-description-add"><br>
          <label for="">Status</label><br>
          <input type="text" id="todo-status-add"><br>
          <label for="">Due Date</label><br>
          <input type="text" id="todo-due_date-add"><br>
          <button type="submit" class="btn btn-primary mb-2" >Submit</button>
        </div>
      </form>
    </center>
  </div>

  <!--form edit todo-->
  <div id="form-edit-todo">
    <center>
      <h1>Form Edit Todo</h1>
      <form >
        <div class="form-group">
          <label for="">Title</label><br>
          <input type="text" id="todo-title-edit"><br>
          <label for="">Description</label><br>
          <input type="text" id="todo-description-edit"><br>
          <label for="">Status</label><br>
          <input type="text" id="todo-status-edit"><br>
          <label for="">Due Date</label><br>
          <input type="text" id="todo-due_date-edit"><br>
          <button type="submit" class="btn btn-primary mb-2">Edit</button>
        </div>
      </form>
    </center>
  </div>

  <!--login-->
  <div id="form-login">
    <center>
      <h1>form Login</h1>
      <form >
        <div class="form-group">
          <label for="">Email</label><br>
          <input type="text" id="login-email"><br>
          <label for="">Password</label><br>
          <input type="password" id="login-password"><br>
          <button type="submit" class="btn btn-primary mb-2">Submit</button>
        </div>
      </form>
    </center>
  </div>

  <!--Register-->
  <div id="form-register">
    <center>
      <h1>form Register</h1>
      <form >
        <div class="form-group">
          <label for="">Email</label><br>
          <input type="text" id="register-email"><br>
          <label for="">Password</label><br>
          <input type="text" id="register-password"><br>
          <label for="">Location</label><br>
          <input type="text" id="register-location"><br>
          <button type="submit" class="btn btn-primary mb-2">Submit</button>
        </div>
      </form>
    </center>
  </div>

  <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
  <script>
    let base_url = "http://localhost:3000/"
    function aut () {
      if(!localStorage.getItem("access_token")) {
        $("#form-login").show()
        $("#form-register").hide()
        $("#form-edit-todo").hide()
        $("#todo-table").hide()
        $("#form-add-todo").hide()
        $("#logout").hide()
        $("#name").hide()
        $("#register").show()
      } else {
        $("#form-login").hide()
        $("#form-register").hide()
        $("#form-edit-todo").hide()
        $("#todo-table").show()
        $("#form-add-todo").show()
        $("#logout").show()
        $("#name").show()
        $("#register").hide()
        getTodos()
      }
    }
    function login() {
      const email = $("#login-email").val()
      const password = $("#login-password").val()
      $.ajax({
        url: base_url + "users/login",
        method: "POST",
        data: {
          email, 
          password
        }
      })
        .done(response => {
          localStorage.setItem("access_token", response.getToken)
          aut()
        })
        .fail((xhr, text) => {
          console.log(xhr, text)
        })
        .always(_ => {
          $("#form-login").trigger("reset")
        })
    }

    function logout() {
      localStorage.clear()
      aut()
    }

    function getTodos() {
      console.log(localStorage.getItem("access_token"))
      $.ajax({
        url: base_url + "todos",
        method: "GET",
        headers: {
          token: localStorage.getItem("access_token")
        }
      })
        .done((respons) => {
          console.log(respons)
          $("#todo-list").empty()
          respons.forEach(value => {
            $("#todo-list").append(`
            <tr>
              <th scope="row">${value.id}</th>
              <td>${value.title}</td>
              <td>${value.description}</td>
              <td>${value.status}</td>
              <td>${value.due_date}</td>
              <td>
                <button class="btn btn-primary mb-2" onclick="showFormEdit(${value.id})">Edit</button>
                <button class="btn btn-primary mb-2" onclick="isDone(${value.id})">Done</button>
                <button class="btn btn-danger" onclick="remove(${value.id})">Delete</button>
            </tr>
            `)
          });
        })
        .fail((xhr, text) => {
          console.log(xhr, text)
        })
    }

    function addTodo() {
      const title = $("#todo-title-add").val()
      const description = $("#todo-description-add").val()
      const status = $("#todo-status-add").val()
      const due_date = $("#todo-due_date-add").val()
      // console.log(title)
      // console.log(description)
      // console.log(status)
      // console.log(due_date)
      $.ajax({
        url: base_url + "todos",
        method: "POST",
        headers: {
          token: localStorage.getItem("access_token")
        },
        data: {
          title,
          description,
          status,
          due_date
        }
      })
        .done(response => {
          console.log('masuk response <<<<<<<<<<<<<<<')
          console.log(response)
          aut()
        })
        .fail((xhr, text) => {
          console.log('masuk fail<<<<<<<<<<<<<')
          console.log(xhr, text)
        })
    }

    function showRegisterForm() {
        $("#form-login").hide()
        $("#form-register").show()
        $("#form-edit-todo").hide()
        $("#todo-table").hide()
        $("#form-add-todo").hide()
        $("#logout").hide()
        $("#name").hide()
        $("#register").hide()
    }

    function register() {
      const email = $("#register-email").val()
      const password = $("#register-password").val()
      const location = $("#register-location").val()
      $.ajax({
        url: base_url + "users/register",
        method: "POST",
        data: {
          email, 
          password,
          location
        }
      })
        .done(response => {
          aut()
        })
        .fail((xhr, text) => {
          console.log(xhr, text)
        })
    }

    function remove(id) {
      $.ajax({
        url: base_url + `todos/${id}`,
        method: "DELETE",
        headers: {
          token: localStorage.getItem("access_token")
        }
      })
        .done(response => {
          aut()
        })
        .fail((xhr, text) => {
          console.log(xhr, text)
        })
    }

    function getOneTodo(id) {
      $.ajax({
        url: base_url + `todos/${id}`,
        method: "GET",
        headers: {
          token: localStorage.getItem("access_token")
        }
      })
        .done(response => {
          console.log(response)
          $("#form-edit-todo").data('val', response.id)
        })
        .fail((xhr, text) => {
          console.log(xhr, text)
        })

    }
    function showFormEdit(id) {
        $("#form-login").hide()
        $("#form-register").hide()
        getOneTodo(id)
        $("#form-edit-todo").show()
        $("#todo-table").hide()
        $("#form-add-todo").hide()
        $("#logout").hide()
        $("#name").hide()
        $("#register").hide()
    }

    function edit(id) {
      const title = $("#todo-title-edit").val()
      const description = $("#todo-description-edit").val()
      const status = $("#todo-status-edit").val()
      const due_date = $("#todo-due_date-edit").val()
      console.log(id)
      console.log(title)
      console.log(description)
      console.log(status)
      console.log(due_date);
      $.ajax({
        url: base_url + `todos/${id}`,
        method: "PUT",
        headers: {
          token: localStorage.getItem("access_token")
        }, 
        data: {
          title,
          description,
          status,
          due_date
        }
      })
        .done(response => {
          aut()
        })
        .fail((xhr, text) => {
          console.log(xhr, text)
        })
    }
    function isDone(id) {
      $.ajax({
        url: base_url + `todos/${id}`,
        method: "PATCH",
        headers: {
          token: localStorage.getItem("access_token")
        }
      })
        .done(response => {
          aut()
        })
        .fail((xhr, text) => {
          console.log(xhr, text)
        })
    }

    $(document).ready(function(){
      aut()
      $("#form-login").on("submit", (e) => {
        e.preventDefault()
        login()
      })
      
      $("#logout").on("click", (e) => {
        e.preventDefault()
        logout()
      })

      $("#form-add-todo").on("submit", (e) => {
        e.preventDefault()
        addTodo()
      })

      $("#register").on("click", (e) => {
        e.preventDefault()
        showRegisterForm()
      })
      $("#form-register").on("submit", (e) => {
        e.preventDefault()
        register()
      })

      $("#form-edit-todo").on("submit", (e) => {
        e.preventDefault()
        let id = $('#form-edit-todo').data('val'); //
        edit(id)
      })
    });
  </script>
</body>
</html>